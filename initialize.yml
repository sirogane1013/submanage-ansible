---
- hosts: webservers
  tasks: 
  - name: deny everything and enable UFW
    ufw:
      state: enabled
      policy: deny
  - name: apt update
    apt:
      update_cache: yes
  - name: install dependencies
    apt:
      name:
        - apache2
        - php
        - php-mbstring
        - php-dom
        - unzip
        - zip
  - name: allow OpenSSH
    ufw:
      rule: allow
      name: OpenSSH
  - name: allow Apache
    ufw:
      rule: allow
      name: Apache

  - name: check composer
    stat: path=/usr/local/bin/composer
    register: composer_bin
    tags: composer
  - block:
    - name: download composer
      get_url: 
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
    - name: install composer
      shell: php /tmp/composer-setup.php --install-dir=/usr/local/bin
    - name: rename composer.phar to composer
      shell: mv /usr/local/bin/composer.phar /usr/local/bin/composer
    - name: make composer executable
      file:
        path: /usr/local/bin/composer
        mode: a+x
        state: file
    when: not composer_bin.stat.exists
    tags: composer
  
  - name: checkout core
    git:
      repo: https://github.com/sirogane1013/submanage-core.git
      dest: /var/www/html/submanage-core
  - name: composer install
    composer:
      command: install
      working_dir: /var/www/html/submanage-core
  - name: generate .env
    template:
      src: ./env.j2
      dest: /var/www/html/submanage-core/.env
  - name: generate APP_KEY
    shell: 
      cmd: php artisan key:generate
      chdir: /var/www/html/submanage-core/
  - name: modify permission (storage)
    file:
      path: /var/www/html/submanage-core/storage
      state: directory
      recurse: yes
      mode: a+w
  - name: modify permission (cache)
    file:
      path: /var/www/html/submanage-core/bootstrap/cache
      state: directory
      recurse: yes
      mode: a+w